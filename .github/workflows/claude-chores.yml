name: Dependabot Auto-Merge

on: pull_request

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - uses: actions/checkout@v4

      - name: Review dependency update
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are reviewing a dependabot dependency update PR. Analyse the changes and post a concise review.

            Check the following:
            1. **React consistency**: If react or react-dom is updated, verify both are the same version in package.json. Mismatches cause fatal runtime errors (React error #527).
            2. **Peer dependencies**: Check if the updated package has peer dependency requirements that conflict with other dependencies in package.json.
            3. **Breaking changes**: Look at what changed in the update. Flag any breaking changes or deprecations.
            4. **Security**: Note if this is a security fix.

            Output format:
            - A brief summary of what the update contains (1-2 sentences)
            - Any concerns found (or "No concerns found")
            - Your verdict: APPROVE or REQUEST_CHANGES

            If you find no issues, approve the PR. If you find concerns (especially React version mismatches or breaking changes), request changes and explain what needs fixing.

  auto-merge:
    runs-on: ubuntu-latest
    needs: [claude-review]
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge patch and minor updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on major updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          gh pr comment "$PR_URL" --body "⚠️ **Major version update detected.** This PR requires manual review before merging.

          Please check the changelog for breaking changes."
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
